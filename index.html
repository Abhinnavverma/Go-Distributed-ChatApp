<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Go Chat</title>
    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --border: #333;
            --primary: #9b59b6; /* That purple you like */
            --text: #fff;
        }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        /* Utility */
        .hidden { display: none !important; }
        .input { width: 100%; padding: 10px; margin-bottom: 10px; background: #333; border: 1px solid var(--border); color: white; border-radius: 4px; box-sizing: border-box; }
        .btn { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn:hover { opacity: 0.9; }

        /* Screen 1: Auth */
        #auth-screen { display: flex; justify-content: center; align-items: center; height: 100%; }
        .auth-box { background: var(--panel); padding: 40px; border-radius: 8px; width: 300px; border: 1px solid var(--border); }

        /* Screen 2: App */
        #app-screen { display: flex; height: 100%; }
        
        /* Sidebar */
        #sidebar { width: 250px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        #search-results { flex: 1; overflow-y: auto; }
        .user-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; }
        .user-item:hover { background: #2a2a2a; }

        /* Chat Area */
        #chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg); }
        #chat-header { padding: 20px; background: var(--panel); border-bottom: 1px solid var(--border); font-weight: bold; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 70%; word-wrap: break-word; }
        .msg.mine { align-self: flex-end; background: var(--primary); color: white; }
        .msg.theirs { align-self: flex-start; background: #333; color: var(--text); }
        .msg-sender { font-size: 0.7em; opacity: 0.7; display: block; margin-bottom: 2px; }

        #input-area { padding: 20px; background: var(--panel); display: flex; gap: 10px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2 style="margin-top:0; text-align:center;">Go Chat</h2>
            <input type="text" id="username" class="input" placeholder="Username">
            <input type="password" id="password" class="input" placeholder="Password">
            <button onclick="login()" class="btn">Login</button>
            <button onclick="register()" class="btn" style="background: #444; margin-top: 10px;">Register</button>
            <p id="auth-error" style="color: #e74c3c; text-align: center; font-size: 0.9em;"></p>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div id="sidebar">
            <div class="sidebar-header">
                <h3>Chats</h3>
                <input type="text" class="input" placeholder="Search users..." onkeyup="handleSearch(this)">
                <button onclick="logout()" class="btn" style="background: #c0392b; font-size: 0.8em; padding: 5px;">Logout</button>
            </div>
            <div id="search-results">
                <div style="padding:20px; color:#666; font-size: 0.9em; text-align:center;">
                    Search for a username above to start chatting.
                </div>
            </div>
        </div>

        <div id="chat-area">
            <div id="chat-header">Select a user...</div>
            <div id="messages"></div>
            <div id="input-area" class="hidden">
                <input type="text" id="msg-input" class="input" placeholder="Type a message..." style="margin-bottom:0;" onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" class="btn" style="width: auto;">Send</button>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let token = localStorage.getItem('token');
        let myUser = localStorage.getItem('username');
        let activeChatID = null;

        // Auto-Redirect if logged in
        if (token && myUser) {
            showApp();
        }

        async function auth(endpoint) {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: u, password: p})
                });
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.message || 'Auth failed');

                if (endpoint === '/register') {
                    alert("Registered! Please login.");
                } else {
                    localStorage.setItem('token', data.access_token);
                    localStorage.setItem('username', data.username);
                    token = data.access_token;
                    myUser = data.username;
                    showApp();
                }
            } catch (e) {
                document.getElementById('auth-error').innerText = e.message;
            }
        }

        function login() { auth('/login'); }
        function register() { auth('/register'); }

        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            connectWS();
        }

        function logout() {
            localStorage.clear();
            if (ws) ws.close();
            location.reload();
        }

        // --- SEARCH ---
        async function handleSearch(el) {
            const q = el.value;
            if (q.length < 1) return;

            const res = await fetch(`/api/users/search?q=${q}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const users = await res.json();
            
            const container = document.getElementById('search-results');
            container.innerHTML = '';

            if (users) {
                users.forEach(u => {
                    if (u.username === myUser) return; // Don't show myself
                    
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.innerHTML = `<span>${u.username}</span> <span style="font-size:0.8em; color:#888;">Chat â†’</span>`;
                    div.onclick = () => startChat(u.id, u.username);
                    container.appendChild(div);
                });
            }
        }

        // --- CHAT START ---
        async function startChat(targetID, targetName) {
            try {
                const res = await fetch('/api/conversations', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ target_id: targetID })
                });
                const data = await res.json();

                activeChatID = data.conversation_id;
                document.getElementById('chat-header').innerText = `Chat with ${targetName}`;
                document.getElementById('input-area').classList.remove('hidden');
                document.getElementById('messages').innerHTML = '';
                
                loadHistory();

            } catch (e) {
                console.error(e);
            }
        }

        async function loadHistory() {
            const res = await fetch(`/api/messages?conversation_id=${activeChatID}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const msgs = await res.json();
            if (msgs) {
                msgs.forEach(m => appendMsg(m.username, m.content));
            }
        }

        // --- REALTIME ---
        function connectWS() {
            ws = new WebSocket(`ws://${location.host}/ws?token=${token}`);
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                // Only show message if it belongs to the CURRENTLY OPEN chat
                if (msg.conversation_id === activeChatID) {
                    appendMsg(msg.username, msg.content);
                } else {
                    // Optional: You could show a notification badge here
                    console.log(`New message from ${msg.username}`);
                }
            };
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const txt = input.value;
            if (!txt) return;

            ws.send(JSON.stringify({
                content: txt,
                conversation_id: activeChatID
            }));
            
            input.value = '';
        }

        function appendMsg(sender, txt) {
            const div = document.createElement('div');
            const isMine = sender === myUser;
            div.className = `msg ${isMine ? 'mine' : 'theirs'}`;
            div.innerHTML = `<span class="msg-sender">${sender}</span>${txt}`;
            
            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>